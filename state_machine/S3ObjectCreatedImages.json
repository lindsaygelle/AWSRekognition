{
    "StartAt": "ProcessSQSEvent",
    "States": {
        "ProcessSQSEvent": {
            "Type": "Map",
            "ItemProcessor": {
                "ProcessorConfig": {
                    "Mode": "INLINE"
                },
                "StartAt": "ParseSQSEventBody",
                "States": {
                    "ParseSQSEventBody": {
                        "Type": "Pass",
                        "Parameters": {
                            "awsRegion.$": "$.awsRegion",
                            "attributes.$": "$.attributes",
                            "body.$": "States.StringToJson($.body)",
                            "eventSource.$": "$.eventSource",
                            "eventSourceARN.$": "$.eventSourceARN",
                            "md5OfBody.$": "$.md5OfBody",
                            "messageAttributes.$": "$.messageAttributes",
                            "messageId.$": "$.messageId",
                            "receiptHandle.$": "$.receiptHandle"
                        },
                        "Next": "CheckSQSBodyRecords"
                    },
                    "CheckSQSBodyRecords": {
                        "Type": "Choice",
                        "Choices": [
                            {
                                "Variable": "$.body.Records",
                                "IsPresent": true,
                                "Next": "ParallelSQSBodyRecords"
                            }
                        ],
                        "Default": "InvalidSQSBody"
                    },
                    "InvalidSQSBody": {
                        "Type": "Pass",
                        "End": true
                    },
                    "ParallelSQSBodyRecords": {
                        "Type": "Parallel",
                        "End": true,
                        "Branches": [
                            {
                                "StartAt": "ProcessSQSBodyRecords",
                                "States": {
                                    "ProcessSQSBodyRecords": {
                                        "Type": "Map",
                                        "ItemProcessor": {
                                            "ProcessorConfig": {
                                                "Mode": "INLINE"
                                            },
                                            "StartAt": "ParallelSQSBodyRecord",
                                            "States": {
                                                "ParallelSQSBodyRecord": {
                                                    "Type": "Parallel",
                                                    "Branches": [
                                                        {
                                                            "StartAt": "CheckSQSBodyRecordEventName",
                                                            "States": {
                                                                "CheckSQSBodyRecordEventName": {
                                                                    "Type": "Choice",
                                                                    "Choices": [
                                                                        {
                                                                            "Or": [
                                                                                {
                                                                                    "Variable": "$.eventName",
                                                                                    "StringEquals": "ObjectCreated:Put"
                                                                                },
                                                                                {
                                                                                    "Variable": "$.eventName",
                                                                                    "StringEquals": "ObjectCreated:Post"
                                                                                },
                                                                                {
                                                                                    "Variable": "$.eventName",
                                                                                    "StringEquals": "ObjectCreated:Copy"
                                                                                },
                                                                                {
                                                                                    "Variable": "$.eventName",
                                                                                    "StringEquals": "ObjectCreated:CompleteMultipartUpload"
                                                                                }
                                                                            ],
                                                                            "Next": "ParallelRekognition"
                                                                        }
                                                                    ],
                                                                    "Default": "InvalidSQSBodyRecordEventName"
                                                                },
                                                                "ParallelRekognition": {
                                                                    "Type": "Parallel",
                                                                    "End": true,
                                                                    "Branches": [
                                                                        {
                                                                            "StartAt": "RekognitionDetectLabels",
                                                                            "States": {
                                                                                "RekognitionDetectLabels": {
                                                                                    "Type": "Task",
                                                                                    "End": true,
                                                                                    "Parameters": {
                                                                                        "Features": [
                                                                                            "GENERAL_LABELS",
                                                                                            "IMAGE_PROPERTIES"
                                                                                        ],
                                                                                        "Image": {
                                                                                            "S3Object": {
                                                                                                "Bucket.$": "$.s3.bucket.name",
                                                                                                "Name.$": "$.s3.object.key"
                                                                                            }
                                                                                        },
                                                                                        "MaxLabels": 0,
                                                                                        "MinConfidence": 50
                                                                                    },
                                                                                    "Resource": "arn:aws:states:::aws-sdk:rekognition:detectLabels"
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                },
                                                                "InvalidSQSBodyRecordEventName": {
                                                                    "Type": "Pass",
                                                                    "End": true
                                                                }
                                                            }
                                                        },
                                                        {
                                                            "StartAt": "PutObjectSQSBodyRecord",
                                                            "States": {
                                                                "PutObjectSQSBodyRecord": {
                                                                    "Type": "Task",
                                                                    "End": true,
                                                                    "Parameters": {
                                                                        "Body.$": "$",
                                                                        "Bucket.$": "$.s3.bucket.name",
                                                                        "Key.$": "States.Format('${aws_s3_object_s3_bucket_notification}event_name={}/{}.json', $.eventName, $.messageId)"
                                                                    },
                                                                    "Resource": "arn:aws:states:::aws-sdk:s3:putObject"
                                                                }
                                                            }
                                                        }
                                                    ],
                                                    "End": true
                                                }
                                            }
                                        },
                                        "End": true,
                                        "ItemsPath": "$.body.Records",
                                        "ItemSelector": {
                                            "attributes.$": "$.attributes",
                                            "awsRegion.$": "$$.Map.Item.Value.awsRegion",
                                            "eventName.$": "$$.Map.Item.Value.eventName",
                                            "eventSource.$": "$$.Map.Item.Value.eventSource",
                                            "eventTime.$": "$$.Map.Item.Value.eventTime",
                                            "eventVersion.$": "$$.Map.Item.Value.eventVersion",
                                            "index.$": "$$.Map.Item.Index",
                                            "messageAttributes.$": "$.messageAttributes",
                                            "md5OfBody.$": "$.md5OfBody",
                                            "messageId.$": "$.messageId",
                                            "receiptHandle.$": "$.receiptHandle",
                                            "requestParameters.$": "$$.Map.Item.Value.requestParameters",
                                            "responseElements.$": "$$.Map.Item.Value.responseElements",
                                            "s3.$": "$$.Map.Item.Value.s3",
                                            "userIdentity.$": "$$.Map.Item.Value.userIdentity"
                                        }
                                    }
                                }
                            }
                        ]
                    }
                }
            },
            "End": true
        }
    }
}
